<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Reaction Time Game</title>
    <style>
        /* Basic styling */
        body {
            font-family: Arial, sans-serif;
            background-color: #f2f2f2;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }
        #chat {
            width: 500px;
            background-color: #fff;
            border: 1px solid #ccc;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        #messages {
            list-style-type: none;
            padding: 0;
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        #messages li {
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
        }
        .input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .input-container input[type="text"] {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        #sendBtn {
            padding: 10px 20px;
            border: none;
            background-color: red;
            color: #fff;
            border-radius: 3px;
            cursor: pointer;
        }
        #sendBtn:hover {
            background-color: darkred;
        }
        #leaderboard {
            width: 500px;
            background-color: #fff;
            border: 1px solid #ccc;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
            text-align: center;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 10px;
            border: 1px solid #ddd;
        }
        th {
            background-color: #007bff;
            color: white;
        }
    </style>
</head>
<body>

    <div id="chat">
        <h2>Reaction Time Game</h2>
        <div class="input-container">
            <input id="username" type="text" placeholder="Enter your name" required />
        </div>
        <button id="startGameBtn" type="button">Start Game</button>
    </div>

    <div id="leaderboard" style="display:none;">
        <h2>Leaderboard</h2>
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Total Reaction Time (ms)</th>
                </tr>
            </thead>
            <tbody id="results-body"></tbody>
        </table>
    </div>

    <script>
        const usernameInput = document.getElementById("username");
        const startGameBtn = document.getElementById("startGameBtn");
        const leaderboard = document.getElementById("leaderboard");
        const resultsBody = document.getElementById("results-body");

        let gameCount = 0;
        let startTime;
        let reactionTimes = [];
        let isWaitingForKeyPress = false;

        startGameBtn.addEventListener("click", function() {
            const username = usernameInput.value.trim();
            if (!username) {
                alert("Please enter your name before starting.");
                return;
            }
            localStorage.setItem("username", username);
            startGame();
        });

        function startGame() {
            gameCount = 0;
            reactionTimes = [];
            showRandomBackground();
        }

        function showRandomBackground() {
            if (gameCount >= 5) {
                const totalReactionTime = reactionTimes.reduce((a, b) => a + b, 0);
                sendResultToServer(totalReactionTime);
                return;
            }

            let randomDelay = Math.floor(Math.random() * (10000 - 3000) + 3000);
            setTimeout(() => {
                document.body.style.backgroundColor = Math.random() < 0.5 ? 'lightblue' : 'lightcoral';
                startTime = Date.now();
                isWaitingForKeyPress = true;
            }, randomDelay);
        }

        function recordReaction(event) {
            if (isWaitingForKeyPress && (event.key === "ArrowLeft" || event.key === "ArrowRight")) {
                let reactionTime = Date.now() - startTime;
                reactionTimes.push(reactionTime);
                document.body.style.backgroundColor = "#f2f2f2";
                gameCount++;
                startTime = null;
                isWaitingForKeyPress = false;
                showRandomBackground();
            }
        }

        async function sendResultToServer(totalReactionTime) {
            const username = localStorage.getItem("username");

            try {
                const response = await fetch("/submit-result", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ username, totalReactionTime }),
                });

                if (!response.ok) {
                    throw new Error("Failed to submit results.");
                }

                fetchResults();
            } catch (error) {
                console.error("Error submitting results:", error);
            }
        }

        async function fetchResults() {
            try {
                const response = await fetch("/get-results");
                if (!response.ok) {
                    throw new Error("Failed to fetch results.");
                }
                const results = await response.json();

                results.sort((a, b) => a.totalReactionTime - b.totalReactionTime);

                resultsBody.innerHTML = "";
                results.forEach(entry => {
                    const row = document.createElement("tr");
                    row.innerHTML = `<td>${entry.username}</td><td>${entry.totalReactionTime} ms</td>`;
                    resultsBody.appendChild(row);
                });

                leaderboard.style.display = "block";
            } catch (error) {
                console.error("Error fetching results:", error);
            }
        }

        document.addEventListener("keydown", recordReaction);
    </script>

</body>
</html>
